<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="android,tinker," />








  <link rel="shortcut icon" type="image/x-icon" href="/images/avatar.png?v=5.1.2" />






<meta name="description" content="前言对于Tinker的原理认识, 一直停留在粗放的认知层面上, 但是对于代码修复的细节原理, 关于资源修复原理, dex差分包的算法原理都没有亲自看一遍源码, 因此关于Tinker会分为两篇进行源码解读工作.">
<meta name="keywords" content="android,tinker">
<meta property="og:type" content="article">
<meta property="og:title" content="Tinker源码解析-代码修复和资源修复">
<meta property="og:url" content="//litten.me/2020/04/21/Tinker源码解析-代码修复和资源修复/index.html">
<meta property="og:site_name" content="天晴日无风">
<meta property="og:description" content="前言对于Tinker的原理认识, 一直停留在粗放的认知层面上, 但是对于代码修复的细节原理, 关于资源修复原理, dex差分包的算法原理都没有亲自看一遍源码, 因此关于Tinker会分为两篇进行源码解读工作.">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="//litten.me/2020/04/21/Tinker源码解析-代码修复和资源修复/Android8.0ClassLoader继承关系.png">
<meta property="og:image" content="//litten.me/2020/04/21/Tinker源码解析-代码修复和资源修复/Context.png">
<meta property="og:image" content="//litten.me/2020/04/21/Tinker源码解析-代码修复和资源修复/获取资源流程.png">
<meta property="og:updated_time" content="2020-04-21T09:58:25.651Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Tinker源码解析-代码修复和资源修复">
<meta name="twitter:description" content="前言对于Tinker的原理认识, 一直停留在粗放的认知层面上, 但是对于代码修复的细节原理, 关于资源修复原理, dex差分包的算法原理都没有亲自看一遍源码, 因此关于Tinker会分为两篇进行源码解读工作.">
<meta name="twitter:image" content="//litten.me/2020/04/21/Tinker源码解析-代码修复和资源修复/Android8.0ClassLoader继承关系.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="//litten.me/2020/04/21/Tinker源码解析-代码修复和资源修复/"/>





  <title>Tinker源码解析-代码修复和资源修复 | 天晴日无风</title>
  







  <script type="text/javascript">
    (function() {
      var hm = document.createElement("script");
      hm.src = "//tajs.qq.com/stats?sId=64926000";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script><!-- hexo-inject:begin --><!-- hexo-inject:end -->








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">天晴日无风</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">燃烧了一颗恒星来相见</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="//litten.me/2020/04/21/Tinker源码解析-代码修复和资源修复/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="天晴日无风">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="天晴日无风">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Tinker源码解析-代码修复和资源修复</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-04-21T00:00:00+08:00">
                2020-04-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/源码解析/" itemprop="url" rel="index">
                    <span itemprop="name">源码解析</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>对于<code>Tinker</code>的原理认识, 一直停留在粗放的认知层面上, 但是对于代码修复的细节原理, 关于资源修复原理, dex差分包的算法原理都没有亲自看一遍源码, 因此关于<code>Tinker</code>会分为两篇进行源码解读工作.<br><a id="more"></a></p>
<h3 id="Tinker代码修复原理"><a href="#Tinker代码修复原理" class="headerlink" title="Tinker代码修复原理"></a><code>Tinker</code>代码修复原理</h3><p>补丁生效, 是在我们应用重启后生效的, 我们可以从TinkerApplication开始看下源码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onBaseContextAttached</span><span class="params">(Context base)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ...</span><br><span class="line">            loadTinker();</span><br><span class="line">            mCurrentClassLoader = base.getClassLoader();</span><br><span class="line">            mInlineFence = createInlineFence(<span class="keyword">this</span>, tinkerFlags, delegateClassName,</span><br><span class="line">                    tinkerLoadVerifyFlag, applicationStartElapsedTime, applicationStartMillisTime,</span><br><span class="line">                    tinkerResultIntent);</span><br><span class="line">            TinkerInlineFenceAction.callOnBaseContextAttached(mInlineFence, base);</span><br><span class="line">            <span class="comment">//reset save mode</span></span><br><span class="line">            <span class="keyword">if</span> (useSafeMode) &#123;</span><br><span class="line">                ShareTinkerInternals.setSafeModeCount(<span class="keyword">this</span>, <span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (TinkerRuntimeException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable thr) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> TinkerRuntimeException(thr.getMessage(), thr);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>Tinker在application启动走到<code>attachBaseContext</code>时, 会调用<code>onBaseContextAttached</code>, 最后走到<code>loadTinker</code> .<code>loadTinker</code>主要做的就是通过<code>TinkerApplication</code>的类加载器去加载loaderClassName, 如果开发者没有自定义配置, 那么这里加载的类就是<code>TinkerLoader</code>, 然后调用他的<code>tryLoad</code>方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// TinkerApplication.java</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">loadTinker</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//reflect tinker loader, because loaderClass may be define by user!</span></span><br><span class="line">            Class&lt;?&gt; tinkerLoadClass = Class.forName(loaderClassName, <span class="keyword">false</span>, TinkerApplication.class.getClassLoader());</span><br><span class="line">            Method loadMethod = tinkerLoadClass.getMethod(TINKER_LOADER_METHOD, TinkerApplication.class);</span><br><span class="line">            Constructor&lt;?&gt; constructor = tinkerLoadClass.getConstructor();</span><br><span class="line">            tinkerResultIntent = (Intent) loadMethod.invoke(constructor.newInstance(), <span class="keyword">this</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            <span class="comment">//has exception, put exception error code</span></span><br><span class="line">            tinkerResultIntent = <span class="keyword">new</span> Intent();</span><br><span class="line">            ShareIntentUtil.setIntentReturnCode(tinkerResultIntent, ShareConstants.ERROR_LOAD_PATCH_UNKNOWN_EXCEPTION);</span><br><span class="line">            tinkerResultIntent.putExtra(INTENT_PATCH_EXCEPTION, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// TinkerLoader.java</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Intent <span class="title">tryLoad</span><span class="params">(TinkerApplication app)</span> </span>&#123;</span><br><span class="line">        Log.d(TAG, <span class="string">"tryLoad test test"</span>);</span><br><span class="line">        Intent resultIntent = <span class="keyword">new</span> Intent();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">long</span> begin = SystemClock.elapsedRealtime();</span><br><span class="line">        tryLoadPatchFilesInternal(app, resultIntent);</span><br><span class="line">        <span class="keyword">long</span> cost = SystemClock.elapsedRealtime() - begin;</span><br><span class="line">        ShareIntentUtil.setIntentPatchCostTime(resultIntent, cost);</span><br><span class="line">        <span class="keyword">return</span> resultIntent;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// TinkerLoader.java</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">tryLoadPatchFilesInternal</span><span class="params">(TinkerApplication app, Intent resultIntent)</span> </span>&#123;</span><br><span class="line">		<span class="comment">// 补丁加载前一些校验代码</span></span><br><span class="line">        ...</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> isEnabledForDex = ShareTinkerInternals.isTinkerEnabledForDex(tinkerFlag);</span><br><span class="line">        <span class="comment">// 是否华为鸿蒙OS</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> isArkHotRuning = ShareTinkerInternals.isArkHotRuning();</span><br><span class="line">        <span class="comment">// 资源, dex, so的校验</span></span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        <span class="comment">//only work for art platform oat，because of interpret, refuse 4.4 art oat</span></span><br><span class="line">        <span class="comment">//android o use quicken default, we don't need to use interpret mode</span></span><br><span class="line">        <span class="keyword">boolean</span> isSystemOTA = ShareTinkerInternals.isVmArt()</span><br><span class="line">            &amp;&amp; ShareTinkerInternals.isSystemOTA(patchInfo.fingerPrint)</span><br><span class="line">            &amp;&amp; Build.VERSION.SDK_INT &gt;= <span class="number">21</span> &amp;&amp; !ShareTinkerInternals.isAfterAndroidO();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//now we can load patch jar</span></span><br><span class="line">        <span class="keyword">if</span> (!isArkHotRuning &amp;&amp; isEnabledForDex) &#123;</span><br><span class="line">        	<span class="comment">// 代码补丁加载</span></span><br><span class="line">            <span class="keyword">boolean</span> loadTinkerJars = TinkerDexLoader.loadTinkerJars(app, patchVersionDirectory, oatDex, resultIntent, isSystemOTA, isProtectedApp);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (isSystemOTA) &#123;</span><br><span class="line">                <span class="comment">// update fingerprint after load success</span></span><br><span class="line">                patchInfo.fingerPrint = Build.FINGERPRINT;</span><br><span class="line">                patchInfo.oatDir = loadTinkerJars ? ShareConstants.INTERPRET_DEX_OPTIMIZE_PATH : ShareConstants.DEFAULT_DEX_OPTIMIZE_PATH;</span><br><span class="line">                <span class="comment">// reset to false</span></span><br><span class="line">                oatModeChanged = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (!SharePatchInfo.rewritePatchInfoFileWithLock(patchInfoFile, patchInfo, patchInfoLockFile)) &#123;</span><br><span class="line">                    ShareIntentUtil.setIntentReturnCode(resultIntent, ShareConstants.ERROR_LOAD_PATCH_REWRITE_PATCH_INFO_FAIL);</span><br><span class="line">                    Log.w(TAG, <span class="string">"tryLoadPatchFiles:onReWritePatchInfoCorrupted"</span>);</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// update oat dir</span></span><br><span class="line">                resultIntent.putExtra(ShareIntentUtil.INTENT_PATCH_OAT_DIR, patchInfo.oatDir);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!loadTinkerJars) &#123;</span><br><span class="line">                Log.w(TAG, <span class="string">"tryLoadPatchFiles:onPatchLoadDexesFail"</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 忽略鸿蒙适配代码</span></span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        <span class="comment">//now we can load patch resource</span></span><br><span class="line">        <span class="keyword">if</span> (isEnabledForResource) &#123;</span><br><span class="line">        	<span class="comment">// 资源补丁加载</span></span><br><span class="line">            <span class="keyword">boolean</span> loadTinkerResources = TinkerResourceLoader.loadTinkerResources(app, patchVersionDirectory, resultIntent);</span><br><span class="line">            <span class="keyword">if</span> (!loadTinkerResources) &#123;</span><br><span class="line">                Log.w(TAG, <span class="string">"tryLoadPatchFiles:onPatchLoadResourcesFail"</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Init component hotplug support.</span></span><br><span class="line">        <span class="keyword">if</span> ((isEnabledForDex || isEnabledForArkHot) &amp;&amp; isEnabledForResource) &#123;</span><br><span class="line">            ComponentHotplug.install(app, securityCheck);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 省略部分代码</span></span><br><span class="line">        <span class="comment">// 包括 杀死主进程以外tinker相关的进程</span></span><br><span class="line">        <span class="comment">// 回调加载成功的通知</span></span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p><code>TinkerLoader#tryLoadPatchFilesInternal</code>主要是做以下几件事情:</p>
<ol>
<li>Tinker 功能的验证(包括 Tinker是否打开, 清单文件的获取和校验)</li>
<li>当前执行进程的判断, 当前执行路径需要在主进程内</li>
<li>补丁文件, 补丁内容(包括dex, resource, so)与清单的校验, 并将相关信息对象存入对应列表对象</li>
<li>代码补丁的加载(TinkerDexLoader.loadTinkerJars)</li>
<li>资源补丁的加载(TinkerResourceLoader.loadTinkerResources)</li>
<li>杀死主进程以外的进程</li>
</ol>
<p>基于大量代码, 这里就不列出来了, 在<code>TinkerDexLoader.loadTinkerJars</code>主要是针对如果设置了<code>tinkerLoadVerifyFlag</code>, 则会进行一些md5安全校验, 然后针对OAT做的一些补丁优化处理, 然后通过<code>SystemClassLoaderAdder.installDexes</code>执行安装补丁的工作<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SystemClassLoaderAdder.java</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">installDexes</span><span class="params">(Application application, ClassLoader loader, File dexOptDir, List&lt;File&gt; files, <span class="keyword">boolean</span> isProtectedApp)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        Log.i(TAG, <span class="string">"installDexes dexOptDir: "</span> + dexOptDir.getAbsolutePath() + <span class="string">", dex size:"</span> + files.size());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!files.isEmpty()) &#123;</span><br><span class="line">        	<span class="comment">// 针对dex进行排序</span></span><br><span class="line">            files = createSortedAdditionalPathEntries(files);</span><br><span class="line">            <span class="comment">// 获取TinkerDexLoader的类加载器, 因为没有指定特定的类加载器处理, 所以用的应该是DVM下的PathClassloade</span></span><br><span class="line">            ClassLoader classLoader = loader;</span><br><span class="line">            <span class="comment">// 非加固应用的apk并且sdk大于等于24</span></span><br><span class="line">            <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= <span class="number">24</span> &amp;&amp; !isProtectedApp) &#123;</span><br><span class="line">                classLoader = NewClassLoaderInjector.inject(application, loader, dexOptDir, files);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//because in dalvik, if inner class is not the same classloader with it wrapper class.</span></span><br><span class="line">                <span class="comment">//it won't fail at dex2opt</span></span><br><span class="line">                <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= <span class="number">23</span>) &#123;</span><br><span class="line">                    V23.install(classLoader, files, dexOptDir);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= <span class="number">19</span>) &#123;</span><br><span class="line">                    V19.install(classLoader, files, dexOptDir);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= <span class="number">14</span>) &#123;</span><br><span class="line">                    V14.install(classLoader, files, dexOptDir);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    V4.install(classLoader, files, dexOptDir);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//install done</span></span><br><span class="line">            sPatchDexCount = files.size();</span><br><span class="line">            Log.i(TAG, <span class="string">"after loaded classloader: "</span> + classLoader + <span class="string">", dex size:"</span> + sPatchDexCount);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!checkDexInstall(classLoader)) &#123;</span><br><span class="line">                <span class="comment">//reset patch dex</span></span><br><span class="line">                SystemClassLoaderAdder.uninstallPatchDex(classLoader);</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> TinkerRuntimeException(ShareConstants.CHECK_DEX_INSTALL_FAIL);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>根据不同的sdk编译版本, tinker做了适配处理, 我们看下<code>V23.install(classLoader, files, dexOptDir)</code><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// V23.java</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">install</span><span class="params">(ClassLoader loader, List&lt;File&gt; additionalClassPathEntries,</span></span></span><br><span class="line"><span class="function"><span class="params">                                    File optimizedDirectory)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> IllegalArgumentException, IllegalAccessException,</span></span><br><span class="line"><span class="function">            NoSuchFieldException, InvocationTargetException, NoSuchMethodException, IOException </span>&#123;</span><br><span class="line">            <span class="comment">/* The patched class loader is expected to be a descendant of</span></span><br><span class="line"><span class="comment">             * dalvik.system.BaseDexClassLoader. We modify its</span></span><br><span class="line"><span class="comment">             * dalvik.system.DexPathList pathList field to append additional DEX</span></span><br><span class="line"><span class="comment">             * file entries.</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            Field pathListField = ShareReflectUtil.findField(loader, <span class="string">"pathList"</span>);</span><br><span class="line">            Object dexPathList = pathListField.get(loader);</span><br><span class="line">            ArrayList&lt;IOException&gt; suppressedExceptions = <span class="keyword">new</span> ArrayList&lt;IOException&gt;();</span><br><span class="line">            ShareReflectUtil.expandFieldArray(dexPathList, <span class="string">"dexElements"</span>, makePathElements(dexPathList,</span><br><span class="line">                <span class="keyword">new</span> ArrayList&lt;File&gt;(additionalClassPathEntries), optimizedDirectory,</span><br><span class="line">                suppressedExceptions));</span><br><span class="line">            <span class="keyword">if</span> (suppressedExceptions.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">for</span> (IOException e : suppressedExceptions) &#123;</span><br><span class="line">                    Log.w(TAG, <span class="string">"Exception in makePathElement"</span>, e);</span><br><span class="line">                    <span class="keyword">throw</span> e;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure></p>
<p>可以看到, 最终, Tinker是通过hook 类加载器内的的pathList对象, 通过调用`DexPathList#makeDexElements, 替换DexPathList对象内的dexElements集合对象, 至此就算Dex补丁加载完成.</p>
<p><code>Tinker</code>的代码补丁加载代码流程我们已经过了一遍, 回头我们再看下为什么代码补丁修复的原理, 首先我们需要理解类加载机制以及Android中的类加载器.</p>
<h4 id="类加载机制以及Android的类加载器"><a href="#类加载机制以及Android的类加载器" class="headerlink" title="类加载机制以及Android的类加载器"></a>类加载机制以及Android的类加载器</h4><p>我们都知道Android的类加载机制, 都是沿用了JVM的双亲委派模型, 那么什么是双亲委派模型? </p>
<blockquote>
<p>双亲委派模型要求除了顶层的启动类加载器外, 其余的类加载器都应有自己的父类加载器. 当一个类加载器收到了类加载的请求, 它首先不会自己去尝试加载这个类, 而是把这个请求委派给父类加载器去完成, 每一个层次的类加载器都是如此, 因此所有的加载请求最终都应该传送到最顶层的启动类加载器中, 只有当父加载器反馈自己无法完成这个加载请求(它的搜索范围中没有找到所需的类)时, 子加载器才会尝试自己去完成加载.  –&lt;深入理解Java虚拟机&gt;</p>
</blockquote>
<p>要知道DVM中是否也是沿用双亲委派机制, 我们可以看下代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// /libcore/ojluni/src/main/java/java/lang/ClassLoader.java</span></span><br><span class="line"><span class="keyword">protected</span> Class&lt;?&gt; loadClass(String name, <span class="keyword">boolean</span> resolve)</span><br><span class="line">        <span class="keyword">throws</span> ClassNotFoundException</span><br><span class="line">    &#123;</span><br><span class="line">    		<span class="comment">// 检查对应的类是否已经被加载过了</span></span><br><span class="line">            <span class="comment">// First, check if the class has already been loaded</span></span><br><span class="line">            Class&lt;?&gt; c = findLoadedClass(name);</span><br><span class="line">            <span class="keyword">if</span> (c == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (parent != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        c = parent.loadClass(name, <span class="keyword">false</span>);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        c = findBootstrapClassOrNull(name);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">                    <span class="comment">// ClassNotFoundException thrown if class not found</span></span><br><span class="line">                    <span class="comment">// from the non-null parent class loader</span></span><br><span class="line">                    <span class="comment">// 如果父类加载器抛出, 说明父类加载器无法完成加载请求</span></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (c == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// If still not found, then invoke findClass in order</span></span><br><span class="line">                    <span class="comment">// to find the class.</span></span><br><span class="line">                    <span class="comment">// 在父类加载器无法加载时</span></span><br><span class="line">                    <span class="comment">// 再调用本身的findClass方法来进行加载</span></span><br><span class="line">                    c = findClass(name);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> c;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>可以看出, 在Android中当需要加载一个类的时候, 也是沿用一样的机制, 当类已经加载, 则使用被加载的类, 否则调用父加载器的loadClass, 如果父加载器为空, 则使用启动类加载器作为父加载器, 如果父类加载器加载失败, 才调用自己的findClass方法进行加载.</p>
<p>Android的类加载器与JVM中的类加载器区别在于, 它加载的是Dex, 而不是Class文件, 我们看下8.0系统下Android类加载器的继承情况<br><img src="./Android8.0ClassLoader继承关系.png" alt="Android8.0ClassLoader继承"><br>通过日志打印, 我们可以看到我们主要用到的ClassLoader是<code>PathClassLoader</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// /libcore/dalvik/src/main/java/dalvik/system/PathClassLoader.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PathClassLoader</span> <span class="keyword">extends</span> <span class="title">BaseDexClassLoader</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PathClassLoader</span><span class="params">(String dexPath, ClassLoader parent)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(dexPath, <span class="keyword">null</span>, <span class="keyword">null</span>, parent);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PathClassLoader</span><span class="params">(String dexPath, String librarySearchPath, ClassLoader parent)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(dexPath, <span class="keyword">null</span>, librarySearchPath, parent);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>PathClassLoader</code>是用来Android用来加载应用类和系统类的加载类, 构造函数的第一个入参<code>dexPath</code>是dex相关文件路径集合, 通过”:”分隔,<br><code>librarySearchPath</code>表示so文件路径集合, 用文件分隔符分隔, 可能为空.它继承于<code>BaseDexClassLoader</code>, 具体方法由父类实现, 以下截取了部分代码,具体源码可以看<a href="http://androidxref.com/8.0.0_r4/xref/libcore/dalvik/src/main/java/dalvik/system/BaseDexClassLoader.java" target="_blank" rel="noopener">这里</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseDexClassLoader</span> <span class="keyword">extends</span> <span class="title">ClassLoader</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> DexPathList pathList;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BaseDexClassLoader</span><span class="params">(String dexPath, File optimizedDirectory,</span></span></span><br><span class="line"><span class="function"><span class="params">            String librarySearchPath, ClassLoader parent)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(parent);</span><br><span class="line">        <span class="keyword">this</span>.pathList = <span class="keyword">new</span> DexPathList(<span class="keyword">this</span>, dexPath, librarySearchPath, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Class&lt;?&gt; findClass(String name) <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">        List&lt;Throwable&gt; suppressedExceptions = <span class="keyword">new</span> ArrayList&lt;Throwable&gt;();</span><br><span class="line">        <span class="comment">// 通过DexPathList查找类</span></span><br><span class="line">        Class c = pathList.findClass(name, suppressedExceptions);</span><br><span class="line">        <span class="keyword">if</span> (c == <span class="keyword">null</span>) &#123;</span><br><span class="line">            ClassNotFoundException cnfe = <span class="keyword">new</span> ClassNotFoundException(</span><br><span class="line">                    <span class="string">"Didn't find class \""</span> + name + <span class="string">"\" on path: "</span> + pathList);</span><br><span class="line">            <span class="keyword">for</span> (Throwable t : suppressedExceptions) &#123;</span><br><span class="line">                cnfe.addSuppressed(t);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">throw</span> cnfe;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> c;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> getClass().getName() + <span class="string">"["</span> + pathList + <span class="string">"]"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>根据源码可以看到, <code>BaseDexClassLoader</code>在创建的时候, 内部维护了一个<code>DexPathList</code>对象, 当查找类, Resource, Dex或So的时候, 都是通过<code>DexPathList</code>间接获取</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// /libcore/dalvik/src/main/java/dalvik/system/DexPathList.java</span></span><br><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">DexPathList</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Element[] dexElements;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DexPathList</span><span class="params">(ClassLoader definingContext, String dexPath,</span></span></span><br><span class="line"><span class="function"><span class="params">            String librarySearchPath, File optimizedDirectory)</span> </span>&#123;</span><br><span class="line">    	...</span><br><span class="line"></span><br><span class="line">        ArrayList&lt;IOException&gt; suppressedExceptions = <span class="keyword">new</span> ArrayList&lt;IOException&gt;();</span><br><span class="line">        <span class="comment">// save dexPath for BaseDexClassLoader</span></span><br><span class="line">        <span class="keyword">this</span>.dexElements = makeDexElements(splitDexPath(dexPath), optimizedDirectory,</span><br><span class="line">                                           suppressedExceptions, definingContext);</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">// 省略其他代码</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 返回一个dex资源集合</span></span><br><span class="line"><span class="comment">     * Makes an array of dex/resource path elements, one per element of</span></span><br><span class="line"><span class="comment">     * the given array.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Element[] makeDexElements(List&lt;File&gt; files, File optimizedDirectory,</span><br><span class="line">            List&lt;IOException&gt; suppressedExceptions, ClassLoader loader) &#123;</span><br><span class="line">      Element[] elements = <span class="keyword">new</span> Element[files.size()];</span><br><span class="line">      <span class="keyword">int</span> elementsPos = <span class="number">0</span>;</span><br><span class="line">      <span class="comment">/*</span></span><br><span class="line"><span class="comment">       * Open all files and load the (direct or contained) dex files up front.</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="keyword">for</span> (File file : files) &#123;</span><br><span class="line">          <span class="keyword">if</span> (file.isDirectory()) &#123;</span><br><span class="line">              <span class="comment">// We support directories for looking up resources. Looking up resources in</span></span><br><span class="line">              <span class="comment">// directories is useful for running libcore tests.</span></span><br><span class="line">              elements[elementsPos++] = <span class="keyword">new</span> Element(file);</span><br><span class="line">          &#125; <span class="keyword">else</span> <span class="keyword">if</span> (file.isFile()) &#123;</span><br><span class="line">              String name = file.getName();</span><br><span class="line"></span><br><span class="line">              <span class="keyword">if</span> (name.endsWith(DEX_SUFFIX)) &#123;</span><br><span class="line">                  <span class="comment">// Raw dex file (not inside a zip/jar).</span></span><br><span class="line">                  <span class="keyword">try</span> &#123;</span><br><span class="line">                      DexFile dex = loadDexFile(file, optimizedDirectory, loader, elements);</span><br><span class="line">                      <span class="keyword">if</span> (dex != <span class="keyword">null</span>) &#123;</span><br><span class="line">                          elements[elementsPos++] = <span class="keyword">new</span> Element(dex, <span class="keyword">null</span>);</span><br><span class="line">                      &#125;</span><br><span class="line">                  &#125; <span class="keyword">catch</span> (IOException suppressed) &#123;</span><br><span class="line">                      System.logE(<span class="string">"Unable to load dex file: "</span> + file, suppressed);</span><br><span class="line">                      suppressedExceptions.add(suppressed);</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                  DexFile dex = <span class="keyword">null</span>;</span><br><span class="line">                  <span class="keyword">try</span> &#123;</span><br><span class="line">                      dex = loadDexFile(file, optimizedDirectory, loader, elements);</span><br><span class="line">                  &#125; <span class="keyword">catch</span> (IOException suppressed) &#123;</span><br><span class="line">                      <span class="comment">/*</span></span><br><span class="line"><span class="comment">                       * IOException might get thrown "legitimately" by the DexFile constructor if</span></span><br><span class="line"><span class="comment">                       * the zip file turns out to be resource-only (that is, no classes.dex file</span></span><br><span class="line"><span class="comment">                       * in it).</span></span><br><span class="line"><span class="comment">                       * Let dex == null and hang on to the exception to add to the tea-leaves for</span></span><br><span class="line"><span class="comment">                       * when findClass returns null.</span></span><br><span class="line"><span class="comment">                       */</span></span><br><span class="line">                      suppressedExceptions.add(suppressed);</span><br><span class="line">                  &#125;</span><br><span class="line"></span><br><span class="line">                  <span class="keyword">if</span> (dex == <span class="keyword">null</span>) &#123;</span><br><span class="line">                      elements[elementsPos++] = <span class="keyword">new</span> Element(file);</span><br><span class="line">                  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                      elements[elementsPos++] = <span class="keyword">new</span> Element(dex, file);</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              System.logW(<span class="string">"ClassLoader referenced unknown path: "</span> + file);</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (elementsPos != elements.length) &#123;</span><br><span class="line">          elements = Arrays.copyOf(elements, elementsPos);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> elements;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> DexFile <span class="title">loadDexFile</span><span class="params">(File file, File optimizedDirectory, ClassLoader loader,</span></span></span><br><span class="line"><span class="function"><span class="params">                                       Element[] elements)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (optimizedDirectory == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> DexFile(file, loader, elements);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            String optimizedPath = optimizedPathFor(file, optimizedDirectory);</span><br><span class="line">            <span class="keyword">return</span> DexFile.loadDex(file.getPath(), optimizedPath, <span class="number">0</span>, loader, elements);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Finds the named class in one of the dex files pointed at by</span></span><br><span class="line"><span class="comment">     * this instance. This will find the one in the earliest listed</span></span><br><span class="line"><span class="comment">     * path element. If the class is found but has not yet been</span></span><br><span class="line"><span class="comment">     * defined, then this method will define it in the defining</span></span><br><span class="line"><span class="comment">     * context that this instance was constructed with.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> name of class to find</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> suppressed exceptions encountered whilst finding the class</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the named class or &#123;<span class="doctag">@code</span> null&#125; if the class is not</span></span><br><span class="line"><span class="comment">     * found in any of the dex files</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Class&lt;?&gt; findClass(String name, List&lt;Throwable&gt; suppressed) &#123;</span><br><span class="line">        <span class="keyword">for</span> (Element element : dexElements) &#123;</span><br><span class="line">            Class&lt;?&gt; clazz = element.findClass(name, definingContext, suppressed);</span><br><span class="line">            <span class="keyword">if</span> (clazz != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> clazz;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (dexElementsSuppressedExceptions != <span class="keyword">null</span>) &#123;</span><br><span class="line">            suppressed.addAll(Arrays.asList(dexElementsSuppressedExceptions));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>PathClassLoader在找一个类的时候, 通过DexPathList#findClass, 会内部对<code>dexElements</code>数组进行遍历, 实际通过<code>Element#findClass</code>去找类, 如果找到则立即返回, 而<code>dexElements</code>数组对象, 在<code>DexPathList</code>初始化时, 通过<code>makeDexElements</code>方法构造对应数组, 这里<code>Element</code>是DexPathList的静态内部类, 它的findClass方法最终调用到了<code>DexFile#loadClassBinaryName</code>方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*package*/</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Element</span> </span>&#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * A file denoting a zip file (in case of a resource jar or a dex jar), or a directory</span></span><br><span class="line"><span class="comment">         * (only when dexFile is null).</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> File path;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> DexFile dexFile;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> ClassPathURLStreamHandler urlHandler;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">boolean</span> initialized;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Element encapsulates a dex file. This may be a plain dex file (in which case dexZipPath</span></span><br><span class="line"><span class="comment">         * should be null), or a jar (in which case dexZipPath should denote the zip file).</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Element</span><span class="params">(DexFile dexFile, File dexZipPath)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.dexFile = dexFile;</span><br><span class="line">            <span class="keyword">this</span>.path = dexZipPath;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Element</span><span class="params">(DexFile dexFile)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.dexFile = dexFile;</span><br><span class="line">            <span class="keyword">this</span>.path = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Element</span><span class="params">(File path)</span> </span>&#123;</span><br><span class="line">          <span class="keyword">this</span>.path = path;</span><br><span class="line">          <span class="keyword">this</span>.dexFile = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> Class&lt;?&gt; findClass(String name, ClassLoader definingContext,</span><br><span class="line">                List&lt;Throwable&gt; suppressed) &#123;</span><br><span class="line">            <span class="keyword">return</span> dexFile != <span class="keyword">null</span> ? dexFile.loadClassBinaryName(name, definingContext, suppressed)</span><br><span class="line">                    : <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>由此我们大概理顺了Tinker代码修复的原理:</p>
<ol>
<li>根据类加载机制, 当一个类被加载后, 当再次请求加载类时, 会先判断对应请求类是否已加载, 如果已加载, 则直接返回</li>
<li>则Tinker只要保证包含修复代码的dex在原来的dex之前被加载, 即可保证修复生效</li>
<li>因为Tinker会针对dex进行排序, 新dex放在之前, 自行生成的testDex放在最后</li>
<li>通过hook获取<code>BaseDexClassLoader</code>内部的<code>pathList</code>对象, 通过<code>DexPathList</code>的<code>makeDexElements</code>方法重新设置内部<code>elements</code>数组, 使得<code>ClassLoader</code>在调用<code>findClass</code>的时候, 可以首先去找到补丁相关的类, 使得后面orginal class不会被加载</li>
</ol>
<h3 id="Tinker资源修复"><a href="#Tinker资源修复" class="headerlink" title="Tinker资源修复"></a><code>Tinker</code>资源修复</h3><h4 id="资源加载与获取流程"><a href="#资源加载与获取流程" class="headerlink" title="资源加载与获取流程"></a>资源加载与获取流程</h4><p>在看<code>Tinker</code>资源修复原理之前, 我们需要了解下资源的获取和加载原理.当我们在调用<code>getResources</code>时, 实际调用的是内部<code>mBase</code>的<code>getResources</code>, 已知, Activity继承于<code>ContextWrapper</code>, 它内部维护一个<code>ContextImpl</code>类的<code>mBase</code>对象(见下图), 所以我们主要看的是<code>ContextImpl#getResource</code>方法<br><img src="./Context.png" alt="Context"><br><code>ContextImpl#getResource</code>是获取内部的<code>mResources</code>,它是通过<code>ContextImpl#createResources</code>赋值生成, 而它的内部是通过<code>ResourceManager</code>去获取Resource</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Resources <span class="title">createResources</span><span class="params">(IBinder activityToken, LoadedApk pi, String splitName,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span> displayId, Configuration overrideConfig, CompatibilityInfo compatInfo)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> String[] splitResDirs;</span><br><span class="line">        <span class="keyword">final</span> ClassLoader classLoader;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            splitResDirs = pi.getSplitPaths(splitName);</span><br><span class="line">            classLoader = pi.getSplitClassLoader(splitName);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NameNotFoundException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ResourcesManager.getInstance().getResources(activityToken,</span><br><span class="line">                pi.getResDir(),</span><br><span class="line">                splitResDirs,</span><br><span class="line">                pi.getOverlayDirs(),</span><br><span class="line">                pi.getApplicationInfo().sharedLibraryFiles,</span><br><span class="line">                displayId,</span><br><span class="line">                overrideConfig,</span><br><span class="line">                compatInfo,</span><br><span class="line">                classLoader);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p><code>ResourceManager</code>是个单例, 内部维护了以<code>ResourcesKey</code>为key的<code>ResourcesImpl</code>缓存集合, 当调用<code>getResources</code>的时候, 首先会去match缓存中的resourceImpl, 当无法命中的情况下, 则创建新的<code>ResourceImpl</code>对象, <code>ResourceImpl</code>是<code>Resource</code>的具体实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="meta">@Nullable</span> <span class="function">Resources <span class="title">getResources</span><span class="params">(@Nullable IBinder activityToken,</span></span></span><br><span class="line"><span class="function"><span class="params">            @Nullable String resDir,</span></span></span><br><span class="line"><span class="function"><span class="params">            @Nullable String[] splitResDirs,</span></span></span><br><span class="line"><span class="function"><span class="params">            @Nullable String[] overlayDirs,</span></span></span><br><span class="line"><span class="function"><span class="params">            @Nullable String[] libDirs,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span> displayId,</span></span></span><br><span class="line"><span class="function"><span class="params">            @Nullable Configuration overrideConfig,</span></span></span><br><span class="line"><span class="function"><span class="params">            @NonNull CompatibilityInfo compatInfo,</span></span></span><br><span class="line"><span class="function"><span class="params">            @Nullable ClassLoader classLoader)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> ResourcesKey key = <span class="keyword">new</span> ResourcesKey(</span><br><span class="line">                    resDir,</span><br><span class="line">                    splitResDirs,</span><br><span class="line">                    overlayDirs,</span><br><span class="line">                    libDirs,</span><br><span class="line">                    displayId,</span><br><span class="line">                    overrideConfig != <span class="keyword">null</span> ? <span class="keyword">new</span> Configuration(overrideConfig) : <span class="keyword">null</span>, <span class="comment">// Copy</span></span><br><span class="line">                    compatInfo);</span><br><span class="line">            classLoader = classLoader != <span class="keyword">null</span> ? classLoader : ClassLoader.getSystemClassLoader();</span><br><span class="line">            <span class="keyword">return</span> getOrCreateResources(activityToken, key, classLoader);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>我们可以看下新建Resource的相关代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="meta">@Nullable</span> <span class="function">Resources <span class="title">getOrCreateResources</span><span class="params">(@Nullable IBinder activityToken,</span></span></span><br><span class="line"><span class="function"><span class="params">            @NonNull ResourcesKey key, @NonNull ClassLoader classLoader)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="comment">// 省略掉通过getOrCreateResourcesForActivityLocked / getOrCreateResourcesLocked查找缓存的相关代码逻辑</span></span><br><span class="line">          ...</span><br><span class="line"></span><br><span class="line">        <span class="comment">// If we're here, we didn't find a suitable ResourcesImpl to use, so create one now.</span></span><br><span class="line">        <span class="comment">// 如果不存在对应的缓存, 则新建ResourcesImpl对象</span></span><br><span class="line">        ResourcesImpl resourcesImpl = createResourcesImpl(key);</span><br><span class="line">        <span class="keyword">if</span> (resourcesImpl == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            ResourcesImpl existingResourcesImpl = findResourcesImplForKeyLocked(key);</span><br><span class="line">            <span class="keyword">if</span> (existingResourcesImpl != <span class="keyword">null</span>) &#123;</span><br><span class="line">                resourcesImpl.getAssets().close();</span><br><span class="line">                resourcesImpl = existingResourcesImpl;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// Add this ResourcesImpl to the cache.</span></span><br><span class="line">                <span class="comment">// 缓存更新</span></span><br><span class="line">                mResourceImpls.put(key, <span class="keyword">new</span> WeakReference&lt;&gt;(resourcesImpl));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> Resources resources;</span><br><span class="line">            <span class="keyword">if</span> (activityToken != <span class="keyword">null</span>) &#123;</span><br><span class="line">                resources = getOrCreateResourcesForActivityLocked(activityToken, classLoader,</span><br><span class="line">                        resourcesImpl, key.mCompatInfo);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                resources = getOrCreateResourcesLocked(classLoader, resourcesImpl, key.mCompatInfo);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> resources;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="meta">@Nullable</span> <span class="function">ResourcesImpl <span class="title">createResourcesImpl</span><span class="params">(@NonNull ResourcesKey key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> DisplayAdjustments daj = <span class="keyword">new</span> DisplayAdjustments(key.mOverrideConfiguration);</span><br><span class="line">        daj.setCompatibilityInfo(key.mCompatInfo);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建AssertManager</span></span><br><span class="line">        <span class="keyword">final</span> AssetManager assets = createAssetManager(key);</span><br><span class="line">        <span class="keyword">if</span> (assets == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> DisplayMetrics dm = getDisplayMetrics(key.mDisplayId, daj);</span><br><span class="line">        <span class="keyword">final</span> Configuration config = generateConfig(key, dm);</span><br><span class="line">        <span class="comment">// 创建新的 ResourcesImpl 对象, 并持有AssetManager对象引用</span></span><br><span class="line">        <span class="keyword">final</span> ResourcesImpl impl = <span class="keyword">new</span> ResourcesImpl(assets, dm, config, daj);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> impl;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="meta">@Nullable</span> <span class="function">AssetManager <span class="title">createAssetManager</span><span class="params">(@NonNull <span class="keyword">final</span> ResourcesKey key)</span> </span>&#123;</span><br><span class="line">        AssetManager assets = <span class="keyword">new</span> AssetManager();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// resDir can be null if the 'android' package is creating a new Resources object.</span></span><br><span class="line">        <span class="comment">// This is fine, since each AssetManager automatically loads the 'android' package</span></span><br><span class="line">        <span class="comment">// already.</span></span><br><span class="line">        <span class="keyword">if</span> (key.mResDir != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (assets.addAssetPath(key.mResDir) == <span class="number">0</span>) &#123;</span><br><span class="line">                Log.e(TAG, <span class="string">"failed to add asset path "</span> + key.mResDir);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (key.mSplitResDirs != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">final</span> String splitResDir : key.mSplitResDirs) &#123;</span><br><span class="line">                <span class="keyword">if</span> (assets.addAssetPath(splitResDir) == <span class="number">0</span>) &#123;</span><br><span class="line">                    Log.e(TAG, <span class="string">"failed to add split asset path "</span> + splitResDir);</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (key.mOverlayDirs != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">final</span> String idmapPath : key.mOverlayDirs) &#123;</span><br><span class="line">                assets.addOverlayPath(idmapPath);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (key.mLibDirs != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">final</span> String libDir : key.mLibDirs) &#123;</span><br><span class="line">                <span class="keyword">if</span> (libDir.endsWith(<span class="string">".apk"</span>)) &#123;</span><br><span class="line">                    <span class="comment">// Avoid opening files we know do not have resources,</span></span><br><span class="line">                    <span class="comment">// like code-only .jar files.</span></span><br><span class="line">                    <span class="keyword">if</span> (assets.addAssetPathAsSharedLibrary(libDir) == <span class="number">0</span>) &#123;</span><br><span class="line">                        Log.w(TAG, <span class="string">"Asset path '"</span> + libDir +</span><br><span class="line">                                <span class="string">"' does not exist or contains no resources."</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> assets;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>可以看到, 创建Resource, 主要是新建AssertManager对象, 通过<code>addAssetPath</code>方法新增资源对应路径维护, 并将对应实例由新建的<code>ResourceImpl</code>对象内部持有. 而<code>Resource</code>的真正实现类为<code>ResourceImpl</code>, 以<code>Resource#getString</code>为例, 它通过<code>mResourcesImpl.getAssets().getResourceText(id)</code>实现, 可以看出, 针对资源的访问, 最终都是与AssertManager有关, 相关简化流程可看下图</p>
<p><img src="./获取资源流程.png" alt="资源获取流程"></p>
<p>那么如果我们来做资源修复, 应该就是需要针对ResourceManager单例里维护的Resources缓存进行处理, 使得对应创建Resource的时候, 可以通过<code>AssertManager#addAssetPath</code>新增新的资源路径达到资源修复的效果.下面我们来看下<code>Tinker</code>是怎么做的.</p>
<h4 id="Tinker资源修复-1"><a href="#Tinker资源修复-1" class="headerlink" title="Tinker资源修复"></a><code>Tinker</code>资源修复</h4><p>上一大节, 我们知道资源修复相关入口代码在<code>TinkerResourceLoader#loadTinkerResources</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">loadTinkerResources</span><span class="params">(TinkerApplication application, String directory, Intent intentResult)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (resPatchInfo == <span class="keyword">null</span> || resPatchInfo.resArscMd5 == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        String resourceString = directory + <span class="string">"/"</span> + RESOURCE_PATH +  <span class="string">"/"</span> + RESOURCE_FILE;</span><br><span class="line">        File resourceFile = <span class="keyword">new</span> File(resourceString);</span><br><span class="line">        <span class="comment">// 省略安全校验代码</span></span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">// 删除加载失败情况下卸载补丁的相关catch代码</span></span><br><span class="line">        TinkerResourcePatcher.monkeyPatchExistingResources(application, resourceString);</span><br><span class="line">        <span class="comment">// 忽略tiker针对运行时资源加载的监控相关代码</span></span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>然后是资源修复的核心代码, 继续往下看</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">monkeyPatchExistingResources</span><span class="params">(Context context, String externalResourceFile)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">       </span><br><span class="line">        <span class="keyword">final</span> ApplicationInfo appInfo = context.getApplicationInfo();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> Field[] packagesFields;</span><br><span class="line">        <span class="comment">// packagesFiled 为 ActivityThread里的mPackages对象, 为ArrayMap类型, key为包名, value为LoadedApk</span></span><br><span class="line">        <span class="comment">// resourcePackagesFiled 为 ActivityThread里的mResourcePackages对象, 为ArrayMap类型, key为包名, value为LoadedApk</span></span><br><span class="line">        <span class="keyword">if</span> (Build.VERSION.SDK_INT &lt; <span class="number">27</span>) &#123;</span><br><span class="line">            packagesFields = <span class="keyword">new</span> Field[]&#123;packagesFiled, resourcePackagesFiled&#125;;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            packagesFields = <span class="keyword">new</span> Field[]&#123;packagesFiled&#125;;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 遍历 packagesFields, 获取所有loadedApk</span></span><br><span class="line">        <span class="keyword">for</span> (Field field : packagesFields) &#123;</span><br><span class="line">            <span class="keyword">final</span> Object value = field.get(currentActivityThread);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (Map.Entry&lt;String, WeakReference&lt;?&gt;&gt; entry</span><br><span class="line">                    : ((Map&lt;String, WeakReference&lt;?&gt;&gt;) value).entrySet()) &#123;</span><br><span class="line">                <span class="keyword">final</span> Object loadedApk = entry.getValue().get();</span><br><span class="line">                <span class="keyword">if</span> (loadedApk == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// resDir 为LoadedApk内mResDir对象, 即资源文件路径</span></span><br><span class="line">                <span class="keyword">final</span> String resDirPath = (String) resDir.get(loadedApk);</span><br><span class="line">                <span class="keyword">if</span> (appInfo.sourceDir.equals(resDirPath)) &#123;</span><br><span class="line">                	<span class="comment">// 通过hook 将resDir设置为补丁资源文件路径</span></span><br><span class="line">                    resDir.set(loadedApk, externalResourceFile);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Create a new AssetManager instance and point it to the resources installed under</span></span><br><span class="line">        <span class="comment">// 创建新的assetManager对象, 并且通过反射调用addAssetPath方法, 添加补丁资源路径</span></span><br><span class="line">        <span class="keyword">if</span> (((Integer) addAssetPathMethod.invoke(newAssetManager, externalResourceFile)) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Could not create new AssetManager"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Kitkat needs this method call, Lollipop doesn't. However, it doesn't seem to cause any harm</span></span><br><span class="line">        <span class="comment">// in L, so we do it unconditionally.</span></span><br><span class="line">        <span class="keyword">if</span> (stringBlocksField != <span class="keyword">null</span> &amp;&amp; ensureStringBlocksMethod != <span class="keyword">null</span>) &#123;</span><br><span class="line">            stringBlocksField.set(newAssetManager, <span class="keyword">null</span>);</span><br><span class="line">            ensureStringBlocksMethod.invoke(newAssetManager);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 遍历ResourceManager内的resource缓存集合</span></span><br><span class="line">        <span class="comment">// 进行遍历</span></span><br><span class="line">        <span class="keyword">for</span> (WeakReference&lt;Resources&gt; wr : references) &#123;</span><br><span class="line">            <span class="keyword">final</span> Resources resources = wr.get();</span><br><span class="line">            <span class="keyword">if</span> (resources == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// Set the AssetManager of the Resources instance to our brand new one</span></span><br><span class="line">            <span class="comment">// 将resourceImpl内的mAssets对象通过hook设置为上面新建的assertManager</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//pre-N</span></span><br><span class="line">                <span class="comment">// assetsFiled 为 resourceImpl内的mAssets</span></span><br><span class="line">                <span class="comment">// 将resourceImpl内的assertManager对象替换为我们新建的对象</span></span><br><span class="line">                assetsFiled.set(resources, newAssetManager);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable ignore) &#123;</span><br><span class="line">                <span class="comment">// N</span></span><br><span class="line">                <span class="keyword">final</span> Object resourceImpl = resourcesImplFiled.get(resources);</span><br><span class="line">                <span class="comment">// for Huawei HwResourcesImpl</span></span><br><span class="line">                <span class="keyword">final</span> Field implAssets = findField(resourceImpl, <span class="string">"mAssets"</span>);</span><br><span class="line">                implAssets.set(resourceImpl, newAssetManager);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Resources内部存在针对TypedArrays的缓存池, 需要清除, 防止获取到的还是老的资源</span></span><br><span class="line">            clearPreloadTypedArrayIssue(resources);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 更新资源</span></span><br><span class="line">            resources.updateConfiguration(resources.getConfiguration(), resources.getDisplayMetrics());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 忽略Android N上针对webview的问题适配</span></span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 通过打开补丁里的only_use_to_test_tinker_resource.txt tinker内部测试资源文件, 来验证资源是否加载成功</span></span><br><span class="line">        <span class="keyword">if</span> (!checkResUpdate(context)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> TinkerRuntimeException(ShareConstants.CHECK_RES_INSTALL_FAIL);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>可以看出Tinker的资源修复步骤如下:</p>
<ol>
<li>通过hook获取apk描述文件loadedApk, 通过hook设置内部维护mRes为资源补丁路径</li>
<li>新建AssetManager, 通过<code>AssetManager#addAssetPath</code>增加资源补丁路径, 通过hook获取ResourceManager内的resources缓存, hook设置ResourceImpl内持有的mAsset为新建的AssetManager</li>
<li>清除TypedArrays缓存池, 更新资源</li>
</ol>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul>
<li>《Android 进阶解密》</li>
<li>《深入理解JVM 第三版》</li>
<li><a href="https://github.com/Tencent/tinker/wiki" target="_blank" rel="noopener">Tinker Github Wiki</a></li>
<li><a href="https://blog.csdn.net/lmj623565791/article/details/54882693" target="_blank" rel="noopener">Android 热修复 Tinker接入及源码浅析</a></li>
<li><a href="https://juejin.im/post/5ab9b4e5f265da23793c2c45#heading-0" target="_blank" rel="noopener">Android 资源加载机制剖析</a></li>
<li><a href="https://www.jianshu.com/p/96d5b83ca26c" target="_blank" rel="noopener">插件化资源处理</a></li>
</ul>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/android/" rel="tag"># android</a>
          
            <a href="/tags/tinker/" rel="tag"># tinker</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/12/17/数据结构-LinkedHashMap/" rel="next" title="数据结构-LinkdHashMap">
                <i class="fa fa-chevron-left"></i> 数据结构-LinkdHashMap
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/06/18/MVVM演进与实践/" rel="prev" title="MVVM演进与实践">
                MVVM演进与实践 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="lv-container" data-id="city" data-uid="MTAyMC8zMjcwMC85MjYx"></div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.png"
               alt="天晴日无风" />
          <p class="site-author-name" itemprop="name">天晴日无风</p>
           
              <p class="site-description motion-element" itemprop="description">开发笔记</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">30</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">7</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">17</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/YuTianTina" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                    
                      GitHub
                    
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#前言"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Tinker代码修复原理"><span class="nav-number">2.</span> <span class="nav-text">Tinker代码修复原理</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#类加载机制以及Android的类加载器"><span class="nav-number">2.1.</span> <span class="nav-text">类加载机制以及Android的类加载器</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Tinker资源修复"><span class="nav-number">3.</span> <span class="nav-text">Tinker资源修复</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#资源加载与获取流程"><span class="nav-number">3.1.</span> <span class="nav-text">资源加载与获取流程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Tinker资源修复-1"><span class="nav-number">3.2.</span> <span class="nav-text">Tinker资源修复</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#参考"><span class="nav-number">4.</span> <span class="nav-text">参考</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2017 - 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">天晴日无风</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.2"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  
    <script type="text/javascript">
      (function(d, s) {
        var j, e = d.getElementsByTagName(s)[0];
        if (typeof LivereTower === 'function') { return; }
        j = d.createElement(s);
        j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
        j.async = true;
        e.parentNode.insertBefore(j, e);
      })(document, 'script');
    </script><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({"tex2jax":{"inlineMath":[["$","$"],["\\(","\\)"]],"skipTags":["script","noscript","style","textarea","pre","code"],"processEscapes":true},"TeX":{"equationNumbers":{"autoNumber":"AMS"}}});
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->
  






  





  

  

  

  
  


  

  

</body>
</html>
